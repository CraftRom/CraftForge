name: Build, Release and Notify

on:
  push:
    tags:
      - "*"
      - "!**-alpha**"
      - "!**-beta**"
  workflow_dispatch:
    inputs:
      is_prerelease:
        description: 'Mark as Pre-release'
        required: true
        type: boolean
        default: true

jobs:
  build_release_notify:
    name: Build APK, Create Release & Notify
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      # ==========================================
      # 1. SETUP & DETERMINE VERSIONING
      # ==========================================
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version and Status
        id: set_status
        run: |
          BUILD_NR="${{ github.run_number }}"
          
          if [ "${{ github.ref_type }}" == "tag" ]; then
            TAG_NAME="${{ github.ref_name }}"
            echo "CREATE_TAG=false" >> $GITHUB_ENV
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
            echo "RELEASE_STATUS=Stable Release" >> $GITHUB_ENV
            echo "BUILD_TYPE=release" >> $GITHUB_ENV
          else
            TAG_NAME="v${BUILD_NR}"
            echo "CREATE_TAG=true" >> $GITHUB_ENV
            if [ "${{ github.event.inputs.is_prerelease }}" == "true" ]; then
              echo "IS_PRERELEASE=true" >> $GITHUB_ENV
              echo "RELEASE_STATUS=Pre-release" >> $GITHUB_ENV
              echo "BUILD_TYPE=debug" >> $GITHUB_ENV
            else
              echo "IS_PRERELEASE=false" >> $GITHUB_ENV
              echo "RELEASE_STATUS=Stable Release" >> $GITHUB_ENV
              echo "BUILD_TYPE=release" >> $GITHUB_ENV
            fi
          fi
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "FULL_VERSION=${TAG_NAME}-b${BUILD_NR}" >> $GITHUB_ENV
          echo "BUILD_NR=$BUILD_NR" >> $GITHUB_ENV

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Bump application version
        uses: chkfung/android-version-actions@v1.2.3
        with:
          gradlePath: app/build.gradle.kts
          versionCode: ${{ env.BUILD_NR }}
          versionName: "${{ env.FULL_VERSION }}"

      # ==========================================
      # 2. PREPARE SIGNING & BUILD
      # ==========================================
      - name: Decode Keystore
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 --decode > app/CraftRom_KEY.jks

      - name: Build APK
        run: |
          if [ "${{ env.BUILD_TYPE }}" == "release" ]; then
            ./gradlew :app:assembleRelease
          else
            ./gradlew :app:assembleDebug
          fi
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Rename & Locate APK
        id: rename_apk
        run: |
          # Ð’Ñ€Ð°Ñ…Ð¾Ð²ÑƒÑ”Ð¼Ð¾ ÑÑƒÑ„Ñ–ÐºÑÐ¸ Ð² ÑˆÐ»ÑÑ…Ð°Ñ… Gradle
          SEARCH_PATH="app/build/outputs/apk/${{ env.BUILD_TYPE }}"
          
          # Ð—Ð½Ð°Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð±ÑƒÐ´ÑŒ-ÑÐºÐ¸Ð¹ APK Ñƒ Ð¿Ð°Ð¿Ñ†Ñ– (Release Ð°Ð±Ð¾ Debug)
          APK_FILE=$(find $SEARCH_PATH -name "*.apk" -print -quit)
          
          if [ -z "$APK_FILE" ]; then
            echo "Error: APK not found in $SEARCH_PATH"
            exit 1
          fi
          
          # Ð¤Ð¾Ñ€Ð¼ÑƒÑ”Ð¼Ð¾ Ð½Ð¾Ð²Ðµ Ñ–Ð¼'Ñ Ñ„Ð°Ð¹Ð»Ñƒ
          NEW_NAME="CraftForge-${{ env.FULL_VERSION }}-${{ env.BUILD_TYPE }}.apk"
          mv "$APK_FILE" "$SEARCH_PATH/$NEW_NAME"
          
          echo "APK_PATH=$SEARCH_PATH/$NEW_NAME" >> $GITHUB_ENV
          echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV

      # ==========================================
      # 3. CHANGELOG & RELEASE
      # ==========================================
      - name: Create Git Tag
        if: env.CREATE_TAG == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag "${{ env.TAG_NAME }}"
          git push origin "${{ env.TAG_NAME }}"

      - name: Generate CHANGELOG.md
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header --output CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: CraftForge ${{ env.FULL_VERSION }}
          body_path: CHANGELOG.md
          prerelease: ${{ env.IS_PRERELEASE == 'true' }}
          files: ${{ env.APK_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # 4. NOTIFICATIONS
      # ==========================================
      - name: Prepare Telegram Message
        id: parse_changelog
        run: |
          RAW_BODY=$(cat CHANGELOG.md)
          CLEAN_BODY=$(echo "$RAW_BODY" | tr -d '\r' | sed 's/`//g' | sed 's/\t/    /g' | sed 's/"/\\"/g')
          TELEGRAM_BODY=$(echo "$CLEAN_BODY" | sed 's/&/\&amp;/g' | sed 's/</\&lt;/g' | sed 's/>/\&gt;/g')
          printf 'RELEASE_BODY_TELEGRAM<<EOF\n%s\nEOF\n' "$TELEGRAM_BODY" >> $GITHUB_ENV
          echo "RELEASE_URL=https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG_NAME }}" >> $GITHUB_ENV

      - name: Send to Telegram
        run: |
          zip -j "${{ env.APK_NAME }}.zip" "${{ env.APK_PATH }}"
          
          MESSAGE="<b>New CraftForge Release (${{ env.RELEASE_STATUS }})</b>\n\n"
          MESSAGE+="<b>Version:</b> <code>${{ env.FULL_VERSION }}</code>\n"
          MESSAGE+="<b>Type:</b> <code>${{ env.BUILD_TYPE }}</code>\n\n"
          MESSAGE+="<b>Changelog:</b>\n${RELEASE_BODY_TELEGRAM}\n\n"
          MESSAGE+="<a href='${{ env.RELEASE_URL }}'>ðŸ”— View on GitHub</a>"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d message_thread_id="${{ secrets.TG_CHAT_THREAD_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview=true

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendDocument" \
            -F chat_id="${{ secrets.TG_CHAT_ID }}" \
            -F message_thread_id="${{ secrets.TG_CHAT_THREAD_ID }}" \
            -F document="@${{ env.APK_NAME }}.zip"